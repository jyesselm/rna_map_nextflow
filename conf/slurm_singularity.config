/*
 * SLURM + Singularity/Apptainer Profile
 * 
 * This profile uses Singularity/Apptainer containers on SLURM clusters.
 * Containers provide consistent environments and eliminate the need for
 * package installation on compute nodes.
 * 
 * Usage:
 *   nextflow run main.nf -profile slurm_singularity \
 *       --container_path /path/to/rna-map.sif \
 *       --fasta ref.fasta --fastq1 reads.fastq
 * 
 * Or set container path in params:
 *   params.container_path = "/path/to/rna-map.sif"
 */

process {
    executor = 'slurm'
    
    // Default resource limits - most tasks only need 1 CPU and 2 GB
    cpus = { task.cpus ?: 1 }
    memory = { task.memory ?: '2 GB' }
    time = { task.time ?: '2h' }
    
    // SLURM-specific settings
    clusterOptions = ""
    
    // Container configuration
    // Default container path (can be overridden via --container_path)
    container = params.container_path ?: "${baseDir}/rna-map.sif"
    
    // Resource limits
    maxForks = params.max_cpus ?: 16
    maxRetries = 3
    errorStrategy = 'retry'
    
    // Process-specific resource requirements
    withLabel: 'process_low' {
        cpus = 1
        memory = '2 GB'
    }
    
    withLabel: 'process_medium' {
        cpus = 1
        memory = '2 GB'
    }
    
    withLabel: 'process_high' {
        cpus = { params.max_cpus ?: 4 }  // Some high tasks may need more CPUs
        memory = { params.max_memory ?: '8 GB' }  // Some high tasks may need more memory
    }
    
    // Custom label for very slow tasks
    withLabel: 'process_slow' {
        cpus = { params.max_cpus ?: 8 }
        memory = { params.max_memory ?: '16 GB' }
    }
    
    // No need for beforeScript with containers - everything is in the image
    // Remove package installation since it's already in the container
}

// Singularity/Apptainer settings (top-level configuration)
singularity {
    enabled = true
    autoMounts = true
    // Mount scratch space if available
    runOptions = System.getenv('SCRATCH') ? "-B ${System.getenv('SCRATCH')}" : ""
}

// Include base configuration
includeConfig "${baseDir}/conf/base.config"

