/*
 * SLURM Optimized Profile - For slow/long-running tasks
 * 
 * This profile optimizes SLURM job submission for workflows with long-running tasks.
 * It uses queue batching and optimized resource allocation.
 * 
 * Usage:
 *   nextflow run main.nf -profile slurm_optimized --fasta ref.fasta --fastq1 reads.fastq
 */

process {
    executor = 'slurm'
    
    // Default resource limits - most tasks only need 1 CPU and 2 GB
    cpus = { task.cpus ?: 1 }
    memory = { task.memory ?: '2 GB' }
    time = { task.time ?: '2h' }
    
    // SLURM-specific settings
    clusterOptions = ""
    
    // Queue optimization - batch multiple tasks to reduce submission overhead
    // Larger queueSize = more tasks batched together = fewer SLURM submissions
    // Set to higher values (10-50) for many fast tasks
    // Set to lower values (1-5) for slow tasks that should run immediately
    queueSize = 10  // Process up to 10 tasks before submitting to queue
    
    // Process-specific resource requirements and queue sizes
    withLabel: 'process_low' {
        cpus = 1
        memory = '2 GB'
        queueSize = 20  // Batch many fast tasks
    }
    
    withLabel: 'process_medium' {
        cpus = 1
        memory = '2 GB'
        queueSize = 10  // Moderate batching
    }
    
    withLabel: 'process_high' {
        cpus = { params.max_cpus ?: 4 }  // Some high tasks may need more CPUs
        memory = { params.max_memory ?: '8 GB' }  // Some high tasks may need more memory
        queueSize = 5   // Less batching for slower tasks
    }
    
    // Custom label for very slow tasks - submit immediately
    withLabel: 'process_slow' {
        cpus = { params.max_cpus ?: 8 }
        memory = { params.max_memory ?: '16 GB' }
        queueSize = 1   // No batching - submit immediately
        time = '24h'
    }
    
    // Poll interval - how often to check for new tasks
    pollInterval = '10s'
    
    // Max concurrent jobs - limits how many SLURM jobs submitted at once
    maxForks = params.max_cpus ?: 16
    
    // Resource limits
    maxRetries = 3
    errorStrategy = 'retry'
}

// Include base configuration
includeConfig "${baseDir}/conf/base.config"
