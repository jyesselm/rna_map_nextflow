/*
 * SLURM + Local + Singularity/Apptainer Profile
 * 
 * This profile submits the main workflow to SLURM, uses local executor
 * for fast tasks, and runs everything in containers. Best for workflows
 * where individual tasks complete quickly (< 5 minutes).
 * 
 * Usage:
 *   nextflow run main.nf -profile slurm_local_singularity \
 *       --container_path /path/to/rna-map.sif \
 *       --fasta ref.fasta --fastq1 reads.fastq
 */

process {
    executor = 'local'
    
    // Default resource limits - most tasks only need 1 CPU and 2 GB
    // For local executor, tasks share the SLURM job resources
    cpus = { task.cpus ?: 1 }
    memory = { task.memory ?: '2 GB' }
    time = { task.time ?: '2h' }
    
    // Container configuration
    container = params.container_path ?: "${baseDir}/rna-map.sif"
    
    // Singularity/Apptainer settings
    singularity {
        enabled = true
        autoMounts = true
        runOptions = System.getenv('SCRATCH') ? "-B ${System.getenv('SCRATCH')}" : ""
    }
    
    // Resource limits - use all CPUs allocated to the SLURM job
    maxForks = params.max_cpus ?: 16
    
    // Queue size - batch tasks to reduce overhead
    queueSize = 0
    
    // Poll interval - how often to check for new tasks
    pollInterval = '5s'
    
    // Process labels - most tasks only need 1 CPU and 2 GB
    withLabel: 'process_low' {
        cpus = 1
        memory = '2 GB'
        time = '1h'
    }
    
    withLabel: 'process_medium' {
        cpus = 1
        memory = '2 GB'
        time = '2h'
    }
    
    withLabel: 'process_high' {
        cpus = { params.max_cpus ?: 4 }  // Some high tasks may need more CPUs
        memory = { 
            def maxMem = params.max_memory ?: '8 GB'
            maxMem
        }
        time = { params.max_time ?: '4h' }
    }
    
    // Error handling
    maxRetries = 3
    errorStrategy = 'retry'
    cleanup = true
}

// Include base configuration
includeConfig "${baseDir}/conf/base.config"

